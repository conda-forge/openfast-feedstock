{% set name = "openfast" %}
{% set version = "3.1.0" %}

{% set cmake_args = "-DDOUBLE_PRECISION=OFF -DCMAKE_INSTALL_LIBDIR=lib" %}

{% set openfast_build_dir = "build_$PKG_HASH" %}
{% set openfastlib_build_dir = "build_$PKG_HASH" %}
{% set openfastmods_build_dir = "build_$PKG_HASH" %}

# Adapted from https://github.com/conda-forge/tbb-feedstock/blob/master/recipe/meta.yaml

package:
  name: {{ name|lower }}
  version: {{ version }}

# source:
#   url: https://github.com/openfast/openfast/archive/v{{ version }}.tar.gz
#   sha256: 2b368e8c8211ebed03e87fb3e89ef733b7e4be4848834da4034f8419d618446c
#   # Download the tar-ball and do `openssl sha256 file.tar.gz` to update

source:
  git_url: https://github.com/openfast/openfast.git
  git_rev: dev
  git_depth: -1 # (Defaults to -1/not shallow)

build:
  number: 14
  skip: true  # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ compiler('fortran') }}
    - {{ compiler('m2w64_c') }}  # [win]
    - {{ compiler('m2w64_cxx') }}  # [win]
    - make
    - cmake
  host:
    - cmake
    - libblas
    - liblapack

outputs:
  - name: openfast
    build:
      script:
        - cmake {{ cmake_args }} -S . -B build
        - cmake --build build --target openfast --parallel
    test:
      commands:
        - openfast -h


  - name: openfast-modules
    build:
      script:
        - cmake {{ cmake_args }} -S . -B build_module_drivers
        - cmake --build build_module_drivers --target aerodyn_driver --parallel
        - cmake --build build_module_drivers --target hydrodyn_driver --parallel
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        - {{ compiler('m2w64_c') }}  # [win]
        - {{ compiler('m2w64_cxx') }}  # [win]
        - make
        - cmake
      host:
        - cmake
        - libblas
        - liblapack
        - libblas
        - liblapack
    test:
      commands:
        - aerodyn_driver -h
        - hydrodyn_driver -h


  - name: openfast-libs
    build:
      script:
        # - cmake {{ cmake_args }} -DBUILD_SHARED_LIBS=ON -DBUILD_OPENFAST_CPP_API=ON -S . -B build_libraries
        - cmake {{ cmake_args }} -DBUILD_SHARED_LIBS=ON -S . -B build_libraries
        - cmake --build build_libraries --target openfastlib --parallel
        # - cmake --build build_libraries --target openfastcpplib --parallel
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        - {{ compiler('m2w64_c') }}  # [win]
        - {{ compiler('m2w64_cxx') }}  # [win]
        - make
        - cmake
      host:
        - cmake
        - libblas
        - liblapack
        - libblas
        - liblapack
    test:
      requires:
        - python
      commands:
        - python -c "import ctypes.util; assert( ctypes.util.find_library('openfastlib') ) is not None"
        # - ls build_libraries/glue-codes/openfast-cpp


  - name: fast.farm
    build:
      script:
        - mkdir build && cd build
        - cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DDOUBLE_PRECISION=OFF -DCMAKE_INSTALL_PREFIX=${PREFIX} -DCMAKE_INSTALL_LIBDIR=lib
        - cmake --build . --target FAST.Farm --parallel
    test:
      commands:
        - FAST.Farm -h


about:
  home: https://github.com/openfast/openfast
  license: Apache-2.0
  license_file: LICENSE
  summary: OpenFAST whole turbine simulation tool
  description: NREL-supported OpenFAST whole-turbine simulation code
  doc_url: http://openfast.readthedocs.io
  dev_url: https://github.com/openfast/openfast

extra:
  recipe-maintainers:
    - rafmudaf
    - openfast
